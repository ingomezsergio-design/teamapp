<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matriz Noviembre - TeamApp</title>
<style>
:root { --bg: #0f172a; --card: #0b1220; --muted: #94a3b8; --accent: #0ea5a4; }
* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background: var(--bg); color: #e2e8f0; font-size: 14px; display: flex; flex-direction: column; }
.wrap { width: 100%; max-width: 100%; padding: 8px; display: flex; flex-direction: column; gap: 10px; flex: 1 1 auto; }
h1 { font-size: 18px; font-weight: 600; margin: 0 0 8px; }
.card { background: rgba(11,18,32,0.85); backdrop-filter: blur(10px); border-radius: 12px; padding: 8px; overflow: auto; flex: 1 1 auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead tr:first-child th { position: sticky; top: 0; z-index: 3; background: #111827; }
thead tr:nth-child(2) th { position: sticky; top: 35px; background: #1f2937; z-index: 4; }
th, td { border-bottom: 1px solid #1f2937; padding: 6px 8px; white-space: nowrap; }
tr:hover td { background: rgba(14,165,164,0.15) !important; transition: background 0.3s ease; }
thead th:nth-child(-n+6), tbody td:nth-child(-n+6) { position: sticky; left: 0; z-index: 2; background: inherit; }
thead th:nth-child(1), tbody td:nth-child(1) { left: 0; }
thead th:nth-child(2), tbody td:nth-child(2) { left: 50px; } /* Ajusta este valor seg√∫n el ancho de tu primera columna */
thead th:nth-child(3), tbody td:nth-child(3) { left: 150px; } /* Ajusta seg√∫n el ancho acumulado */
thead th:nth-child(4), tbody td:nth-child(4) { left: 250px; }
thead th:nth-child(5), tbody td:nth-child(5) { left: 350px; }
thead th:nth-child(6), tbody td:nth-child(6) { left: 450px; }
thead tr:nth-child(2) th:nth-child(-n+6) { z-index: 5; }
.filter-dropdown { position: relative; display: inline-block; }
.filter-btn { background: #1f2937; color: #f8fafc; padding: 4px 8px; font-size: 12px; border: 1px solid #374151; border-radius: 4px; text-align: left; cursor: pointer; }
.filter-btn:after { content: " ‚ñº"; }
.filter-content { display: none; position: absolute; top: 100%; left: 0; background: #1f2937; border: 1px solid #374151; border-radius: 4px; z-index: 10; min-width: max-content; max-height: 250px; overflow-y: auto; margin-top: 2px; padding: 8px; opacity: 0; transform: scaleY(0); transform-origin: top; transition: transform 0.18s ease, opacity 0.18s ease; }
.filter-search { width: 100%; padding: 6px; margin-bottom: 6px; border-radius: 4px; border: 1px solid #374151; background: #0b1220; color: #e2e8f0; font-size: 12px; position: sticky; top: 0; z-index: 6; }
.filter-content label { display: block; font-size: 12px; color: #f8fafc; cursor: pointer; padding: 2px 0; }
.filter-dropdown.show .filter-content { display: block; opacity:1; transform: scaleY(1); }
.button-row { display: flex; gap: 10px; justify-content: flex-start; align-items: center; margin-bottom: 10px; }
.back-button { display: inline-block; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); color:#fff; padding:8px 16px; text-decoration:none; font-size:0.9rem; font-weight:bold; border-radius:10px; margin:0; border: 1px solid rgba(255,255,255,0.2); transition:0.3s; }
.back-button:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }
.loader-wrapper { display: flex; align-items: center; justify-content: center; height: 100%; }
.loader-card { background: rgba(14,165,164,0.15); backdrop-filter: blur(8px); padding: 20px 30px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; gap: 12px; border: 1px solid rgba(14,165,164,0.3); }
.loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(14,165,164,0.3); border-top: 5px solid #0ea5a4; border-radius: 50%; animation: spin 1s linear infinite; }
.loader-text { font-size: 14px; color: #e2e8f0; font-weight: 500; text-align: center; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="wrap">
    <h1>Matriz Noviembre</h1>
    <div class="button-row">
        <button id="clear-filters" class="back-button" style="background:rgba(14,165,164,0.2);">üßπ Limpiar filtros</button>
        <a href="{{ url_for('home') }}" class="back-button">‚¨Ö Volver al Panel</a>
    </div>

    <div id="content" class="card">
        <div class="loader-wrapper">
            <div class="loader-card">
                <div class="loader-spinner"></div>
                <div class="loader-text">Cargando datos de la matriz...</div>
            </div>
        </div>
    </div>
</div>

<script>
    const contentEl = document.getElementById('content');
    const clearFiltersBtn = document.getElementById('clear-filters');
    let dataCache = null;
    let rowsElCache = null;

    // Llama a la nueva API de Flask para obtener los datos
    fetch('/api/matriz-noviembre/data')
        .then(response => response.json())
        .then(data => {
            if (data.error) throw new Error(data.error);
            dataCache = data;
            render(data);
        })
        .catch(err => {
            console.error(err);
            contentEl.innerHTML = `<div style="text-align:center;color:var(--muted)">Error al cargar: ${err.message}</div>`;
        });
    
    function render(data) {
        if (!data?.headers || data.headers.length === 0) {
            contentEl.innerHTML = '<div style="text-align:center;color:var(--muted)">La hoja est√° vac√≠a.</div>';
            return;
        }

        const { headers, rows, colors } = data;
        const topHeaders = headers;
        const subHeaders = rows?.length > 0 ? rows[0] : [];
        const dataRows = rows?.length > 1 ? rows.slice(1) : [];
        const colorRows = colors?.length > 1 ? colors.slice(1) : [];

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        
        const trA = document.createElement('tr');
        topHeaders.forEach(h => {
            const th = document.createElement('th');
            th.textContent = h;
            trA.appendChild(th);
        });
        thead.appendChild(trA);

        const trFilters = document.createElement('tr');
        subHeaders.forEach((hSub, i) => {
            const th = document.createElement('th');
            th.appendChild(createFilterDropdown(i, dataRows));
            trFilters.appendChild(th);
        });
        thead.appendChild(trFilters);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        dataRows.forEach((r, rowIndex) => {
            const tr = document.createElement('tr');
            r.forEach((c, colIndex) => {
                const td = document.createElement('td');
                const bg = colorRows?.[rowIndex]?.[colIndex] || '#0f172a';
                td.style.background = bg;
                td.style.color = getContrastYIQ(bg);
                td.textContent = c;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        contentEl.innerHTML = '';
        contentEl.appendChild(table);
        rowsElCache = Array.from(contentEl.querySelectorAll('tbody tr'));
        
        // Adjuntar eventos
        clearFiltersBtn.addEventListener('click', clearFilters);
        contentEl.addEventListener('click', handleClicks);
        contentEl.addEventListener('change', handleChange);
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-dropdown.show').forEach(d => d.classList.remove('show'));
            }
        });
    }

    function createFilterDropdown(colIndex, dataRows) {
        const dropdown = document.createElement('div');
        dropdown.className = 'filter-dropdown';

        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.textContent = `Filtrar Col ${colIndex + 1}`;
        dropdown.appendChild(btn);

        const content = document.createElement('div');
        content.className = 'filter-content';

        const search = document.createElement('input');
        search.type = 'text';
        search.placeholder = 'Buscar...';
        search.className = 'filter-search';
        content.appendChild(search);
        
        const selectAllLabel = document.createElement('label');
        const selectAllInput = document.createElement('input');
        selectAllInput.type = 'checkbox';
        selectAllInput.className = 'select-all';
        selectAllLabel.appendChild(selectAllInput);
        selectAllLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
        content.appendChild(selectAllLabel);

        const uniqueValues = [...new Set(dataRows.map(r => r[colIndex] || ''))].sort();
        uniqueValues.forEach(v => {
            const lbl = document.createElement('label');
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'filter-checkbox';
            cb.value = v;
            lbl.appendChild(cb);
            lbl.appendChild(document.createTextNode(` ${v === '' ? '(Vac√≠o)' : v}`));
            content.appendChild(lbl);
        });

        dropdown.appendChild(content);
        return dropdown;
    }

    function handleClicks(e) {
        if (e.target.matches('.filter-btn')) {
            const parent = e.target.closest('.filter-dropdown');
            document.querySelectorAll('.filter-dropdown.show').forEach(d => {
                if (d !== parent) d.classList.remove('show');
            });
            parent.classList.toggle('show');
        }
    }

    function handleChange(e) {
        const target = e.target;
        if (target.matches('.select-all')) {
            const parent = target.closest('.filter-content');
            parent.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = target.checked);
        }
        if (target.matches('.filter-checkbox, .select-all')) {
            applyFilters();
        }
    }

    function applyFilters() {
        const activeFilters = {};
        document.querySelectorAll('.filter-dropdown').forEach((dropdown, colIndex) => {
            const checked = dropdown.querySelectorAll('.filter-checkbox:checked');
            if (checked.length > 0) {
                activeFilters[colIndex] = new Set(Array.from(checked).map(cb => cb.value));
            }
        });

        rowsElCache.forEach(row => {
            let isVisible = true;
            for (const colIndex in activeFilters) {
                const cellValue = row.cells[colIndex]?.textContent || '';
                if (!activeFilters[colIndex].has(cellValue)) {
                    isVisible = false;
                    break;
                }
            }
            row.style.display = isVisible ? '' : 'none';
        });
    }

    function clearFilters() {
        document.querySelectorAll('.filter-checkbox, .select-all').forEach(cb => cb.checked = false);
        applyFilters();
    }
    
    function getContrastYIQ(hex) {
        if (!hex) return '#ffffff';
        hex = hex.replace('#','');
        let r = parseInt(hex.substr(0,2),16), g = parseInt(hex.substr(2,2),16), b = parseInt(hex.substr(4,2),16);
        return ((r*299 + g*587 + b*114) / 1000) >= 128 ? '#000000' : '#ffffff';
    }
</script>
</body>
</html>
