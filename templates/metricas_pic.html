<!doctype html>
<html lang="es">
<head>
Â  Â  <meta charset="utf-8">
Â  Â  <meta name="viewport" content="width=device-width,initial-scale=1">
Â  Â  <title>Metricas PIC - TeamApp</title>
Â  Â  <style>
Â  Â  Â  Â  :root{ --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#0ea5a4; }
Â  Â  Â  Â  *{ box-sizing:border-box }
Â  Â  Â  Â  
Â  Â  Â  Â  /* SOLUCIÃ“N 1: Quitar fondo negro al seleccionar texto */
Â  Â  Â  Â  ::selection {
Â  Â  Â  Â  Â  Â  background: var(--accent);
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  }

Â  Â  Â  Â  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:#e2e8f0; font-size:14px; }
Â  Â  Â  Â  .wrap{ max-width:100%; margin-inline:auto; padding:8px; display:flex; flex-direction:column; gap:10px; }
Â  Â  Â  Â  h1{ font-size:18px; font-weight:600; margin:0 0 8px; }
Â  Â  Â  Â  .card { background: rgba(11, 18, 32, 0.85); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.05); border-radius:12px; padding:8px; box-shadow:0 8px 24px rgba(0,0,0,.4); transition: transform 0.2s ease, box-shadow 0.2s ease; }
Â  Â  Â  Â  .card:hover { transform: translateY(-2px); box-shadow:0 12px 32px rgba(0,0,0,.5); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  table{Â 
Â  Â  Â  Â  Â  Â  width:100%;Â 
Â  Â  Â  Â  Â  Â  border-collapse:collapse;Â 
Â  Â  Â  Â  Â  Â  font-size:13px;Â 
Â  Â  Â  Â  Â  Â  table-layout: auto; /* Permite scroll horizontal */
Â  Â  Â  Â  }
Â  Â  Â  Â  thead th{ position: sticky; top: 0; color:#f8fafc; text-align:left; z-index:3; padding:6px 8px; background: #111827;}
Â  Â  Â  Â  th,td{Â 
Â  Â  Â  Â  Â  Â  /* Corregido el valor '1f2en-US: 937' por '1f2937' */
Â  Â  Â  Â  Â  Â  border-bottom:1px solid #1f2937;Â 
Â  Â  Â  Â  Â  Â  padding:6px 8px;Â 
Â  Â  Â  Â  Â  Â  white-space:nowrap; /* Clave para el scroll horizontal */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Color de hover para celdas normales */
Â  Â  Â  Â  tr:hover td { background: rgba(14,165,164,0.15) !important; transition: background 0.3s ease; }
Â  Â  Â  Â  
Â  Â  Â  Â  .hint{ color:var(--muted); font-size:11px; margin:2px 0 8px }
Â  Â  Â  Â  .table-wrap{ overflow:auto; max-height:85vh; border-radius:12px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ðŸ“Œ Ajustes de celdas pegajosas (primer columna) */
Â  Â  Â  Â  thead th:first-child, tbody td:first-child {Â 
Â  Â  Â  Â  Â  Â  position: sticky;Â 
Â  Â  Â  Â  Â  Â  left: 0;Â 
Â  Â  Â  Â  Â  Â  z-index: 4;Â 
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  background: #111827; /* Fondo por defecto, debe ser igual al thead para que no se vea cortado */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Fondo de la celda de la columna AGENTE, asegurando que cubra el fondo de la tarjeta */
Â  Â  Â  Â  tbody td:first-child { 
Â  Â  Â  Â  Â  Â  /* DEBEMOS USAR EL COLOR DE FONDO DE LA TARJETA (.card) O EL FONDO BASE (--bg) 
Â  Â  Â  Â  Â  Â  Â  * Para que el scroll horizontal funcione sin ver un corte. 
Â  Â  Â  Â  Â  Â  Â  * Vamos a usar el color de la variable --bg para la celda y el hover: */
Â  Â  Â  Â  Â  Â  background: var(--bg);
Â  Â  Â  Â  Â  Â  z-index: 2;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Aplicar el color de hover a la celda pegajosa de la primera columna */
Â  Â  Â  Â  tr:hover td:first-child {
Â  Â  Â  Â  Â  Â  background: rgba(14,165,164,0.15) !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Asegurar que la primera celda del encabezado use el color correcto */
Â  Â  Â  Â  thead th:first-child { 
Â  Â  Â  Â  Â  Â  background: #111827; 
Â  Â  Â  Â  Â  Â  z-index: 5; /* Aseguramos que estÃ© por encima de todo */
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  .empty{ padding:16px; text-align:center; color:var(--muted) }
Â  Â  Â  Â  input#search { width:100%; padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #1f2937; background:#111827; color:#f8fafc; transition: all 0.2s ease; }
Â  Â  Â  Â  input#search:focus { outline:none; border-color: var(--accent); box-shadow: 0 0 10px var(--accent, #0ea5a4); }
Â  Â  Â  Â  .back-button { display: inline-block; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); color: #fff; padding: 12px 22px; text-align: center; text-decoration: none; font-size: 1.1rem; font-weight: bold; border-radius: 10px; transition: 0.3s; margin: 10px auto 0 auto; border: 1px solid rgba(255,255,255,0.2); width: max-content; }
Â  Â  Â  Â  .back-button:hover { background: rgba(255,255,255,0.25); transform: scale(1.05); }
Â  Â  Â  Â  .loader { display: flex; justify-content: center; align-items: center; padding: 40px 0; }
Â  Â  Â  Â  .loader .dot { width: 12px; height: 12px; margin: 0 6px; background: var(--accent); border-radius: 50%; animation: bounce 0.6s infinite alternate; }
Â  Â  Â  Â  .loader .dot:nth-child(2) { animation-delay: 0.2s; }
Â  Â  Â  Â  .loader .dot:nth-child(3) { animation-delay: 0.4s; }
Â  Â  Â  Â  @keyframes bounce { 0% { transform: translateY(0); opacity: 0.6; } 100% { transform: translateY(-12px); opacity: 1; } }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="wrap">
Â  Â  Â  Â  <h1>Metricas PIC</h1>
Â  Â  Â  Â  <div class="hint">Fuente: Google Sheet (Metricas PIC)</div>
Â  Â  Â  Â  <input id="search" placeholder="Filtrar desde la fila 3..." />
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="content" class="card">
Â  Â  Â  Â  Â  Â  <div class="loader">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dot"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dot"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dot"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:center; color:var(--muted); font-size:13px; margin-top:8px;">Cargando datos...</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <a href="{{ url_for('home') }}" class="back-button">â¬… Volver al Panel</a>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // La llamada fetch sigue siendo la misma, pero ahora esperamos datos con colores
Â  Â  Â  Â  fetch('/api/metricas-pic/data')
Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  .then(render)
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar los datos:", error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('content').innerHTML = `<div class="empty">Error al cargar los datos: ${error.message}</div>`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  function render(data){
Â  Â  Â  Â  Â  Â  const el = document.getElementById('content');
Â  Â  Â  Â  Â  Â  const { headers, rows } = data || {};
Â  Â  Â  Â  Â  Â  if (!headers || headers.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  el.innerHTML = '<div class="empty">La hoja estÃ¡ vacÃ­a o no tiene datos.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const thead = '<thead><tr>' + headers.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr></thead>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- LÃ“GICA MODIFICADA PARA APLICAR COLORES ---
Â  Â  Â  Â  Â  Â  const tbody = '<tbody>' + rows.map(row =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  '<tr>' + row.map(cell => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bgColor = cell.color || '#0f172a'; // Color de fondo o fallback
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const textColor = getContrastYIQ(bgColor); // Calcula si el texto debe ser blanco o negro
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Aplicamos el color de fondo y el color de texto dinÃ¡micamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<td style="background-color:${bgColor}; color:${textColor};">${escapeHtml(cell.value)}</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('') + '</tr>'
Â  Â  Â  Â  Â  Â  ).join('') + '</tbody>';

Â  Â  Â  Â  Â  Â  el.classList.add('table-wrap');
Â  Â  Â  Â  Â  Â  el.innerHTML = `<table>${thead}${tbody}</table>`;

Â  Â  Â  Â  Â  Â  // La lÃ³gica del buscador no cambia
Â  Â  Â  Â  Â  Â  const searchInput = document.getElementById('search');
Â  Â  Â  Â  Â  Â  searchInput.addEventListener('input', function(){
Â  Â  Â  Â  Â  Â  Â  Â  const filter = this.value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  el.querySelectorAll('tbody tr').forEach((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(index < 2) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const text = row.innerText.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.style.display = text.includes(filter) ? '' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function escapeHtml(s){
Â  Â  Â  Â  Â  Â  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FUNCIÃ“N NUEVA para calcular el contraste del texto ---
Â  Â  Â  Â  function getContrastYIQ(hexcolor){
Â  Â  Â  Â  Â  Â  if(!hexcolor) return '#e2e8f0'; // Color de texto por defecto
Â  Â  Â  Â  Â  Â  hexcolor = hexcolor.replace('#','');
Â  Â  Â  Â  Â  Â  let r = parseInt(hexcolor.substr(0,2),16);
Â  Â  Â  Â  Â  Â  let g = parseInt(hexcolor.substr(2,2),16);
Â  Â  Â  Â  Â  Â  let b = parseInt(hexcolor.substr(4,2),16);
Â  Â  Â  Â  Â  Â  let yiq = ((r*299)+(g*587)+(b*114))/1000;
Â  Â  Â  Â  Â  Â  // Si el fondo es oscuro, devuelve texto claro. Si es claro, devuelve texto oscuro.
Â  Â  Â  Â  Â  Â  return (yiq >= 128) ? '#111827' : '#f8fafc';
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
